---
// src/pages/company/[slug].astro

import Base from "../../layouts/Base.astro";
import { strapi, unwrap, mediaUrl } from "../../lib/strapi";
import { iconForPlatform } from "../../lib/socialIcons";
import CompanyHeader from "../../components/CompanyHeader.astro";
import CompanyReasoning from "../../components/CompanyReasoning.astro";
import CompanyContact from "../../components/CompanyContact.astro";
import CompanySources from "../../components/CompanySources.astro";
import CompanyShare from "../../components/CompanyShare.astro";
import CompanyActionItems from "../../components/CompanyActionItems.astro";

import "../../styles/company.css";

export async function getStaticPaths() {
  const pageSize = 100;
  let page = 1;
  let paths: { params: { slug: string } }[] = [];

  while (true) {
    const res = await strapi(
      `/api/companies?publicationState=live&fields=slug&pagination[page]=${page}&pagination[pageSize]=${pageSize}`
    );
    const data = unwrap<any[]>(res) ?? [];
    paths.push(...data.map((c: any) => ({ params: { slug: c.slug } })));

    const meta = (res as any)?.meta?.pagination;
    if (!meta || page >= (meta.pageCount ?? 1)) break;
    page++;
  }

  return paths;
}

const { slug } = Astro.params;

/* ---------- Fetch ---------- */
const params = new URLSearchParams();
params.set("publicationState", "live");
params.set("filters[slug][$eq]", String(slug ?? ""));

// include new intro + keep about as short text
params.set("fields", "name,slug,about,intro,ticker,boycott_target");

// multiple populate keys
[
  "logo",
  "sector",
  "Evaluation",
  "Evaluation.reasoning_tags",
  "contact",
  "Reasoning",
  "Reasoning.Source",
  "ActionItems",

  // parent chain (only parent_company exists)
  "parent_company",
  "parent_company.Reasoning",
  "parent_company.Reasoning.Source",
  "parent_company.ActionItems",
].forEach((key) => params.append("populate", key));

const res = await strapi(`/api/companies?${params.toString()}`);
const arr = unwrap<any[]>(res) ?? [];
const company = (Array.isArray(arr) ? arr[0] : null);

if (!company) {
  return new Response("Company not found", { status: 404 });
}

/* ---------- Logo ---------- */
const logoNode = company?.logo?.data?.attributes ?? company?.logo ?? null;
const logoUrlRaw = logoNode?.url ?? "";
const logoFormats = logoNode?.formats ?? {};
const src = logoUrlRaw ? mediaUrl(logoUrlRaw) : "";
const srcSmall = logoFormats?.thumbnail?.url ? mediaUrl(logoFormats.thumbnail.url) : "";
const srcMedium = logoFormats?.small?.url ? mediaUrl(logoFormats.small.url) : "";
const logoAlt = logoNode?.alternativeText ?? `${company.name} logo`;

const srcSet = [srcSmall && `${srcSmall} 156w`, srcMedium && `${srcMedium} 500w`, src && `${src} 779w`]
  .filter(Boolean)
  .join(", ");



/* ---------- Content ---------- */
const about: string | undefined = company.about;
const introHtml: string | undefined = company.intro;
const actions: any[] = Array.isArray(company.ActionItems) ? company.ActionItems : [];

/* ---------- Reasoning + Sources (company) ---------- */
const reasoningBlock: any | null = company.Reasoning ?? null;
const reasoningHtml: string = reasoningBlock?.content || "";
const sources: any[] = Array.isArray(reasoningBlock?.Source) ? reasoningBlock.Source : [];

/* ---------- Parent company reasoning + actions ---------- */

const parentCompanyRaw: any[] =
  Array.isArray(company.parent_company?.data)
    ? company.parent_company.data
    : Array.isArray(company.parent_company)
    ? company.parent_company
    : [];

// Reasoning blocks
const parentReasonBlocks = parentCompanyRaw
  .map((node: any) => {
    const attrs = node?.attributes ?? node ?? {};
    const block = attrs.Reasoning ?? null;
    const html = block?.content || "";
    const srcs: any[] = Array.isArray(block?.Source) ? block.Source : [];

    return {
      name: attrs.name ?? "",
      slug: attrs.slug ?? "",
      reasoningHtml: html,
      sources: srcs,
    };
  })
  .filter((p) => p.reasoningHtml && p.reasoningHtml.trim().length > 0);

// Parent action items – grouped by parent company
const parentActions = parentCompanyRaw
  .map((node: any) => {
    const attrs = node?.attributes ?? node ?? {};
    const parentName = attrs.name ?? "";
    const list: any[] = Array.isArray(attrs.ActionItems) ? attrs.ActionItems : [];

    return {
      companyName: parentName,
      actions: list,
    };
  })
  .filter((p) => p.companyName && p.actions.length > 0);

// Combined sources: company first, then all parents
const allSources: any[] = [
  ...sources,
  ...parentReasonBlocks.flatMap((p) => p.sources),
];

/* ---------- Evaluation ---------- */
const evaln = company.Evaluation ?? null;
const sentiment: "good" | "bad" | undefined =
  evaln?.sentiment === "good" || evaln?.sentiment === "bad" ? evaln.sentiment : undefined;

const badgeClass =
  sentiment === "good"
    ? "badge badge-success normal-case"
    : sentiment === "bad"
    ? "badge badge-error normal-case"
    : "";

// reasoning tags
let rawTags: any[] = [];
if (Array.isArray(evaln?.reasoning_tags)) {
  rawTags = evaln.reasoning_tags;
} else if (Array.isArray(evaln?.reasoning_tags?.data)) {
  rawTags = evaln.reasoning_tags.data.map((x: any) => x?.attributes ?? x);
}
const reasonTags = rawTags
  .map((t: any) => t && { name: t.name, color: t.color })
  .filter(Boolean);

const evalSummary = evaln?.summary ?? "";

function textColorFor(bg: string) {
  if (!bg) return "white";
  const c = bg.replace("#", "");
  const r = parseInt(c.slice(0, 2), 16);
  const g = parseInt(c.slice(2, 4), 16);
  const b = parseInt(c.slice(4, 6), 16);
  return ((0.299 * r + 0.587 * g + 0.114 * b) / 255) > 0.6 ? "black" : "white";
}

// Build canonical URL for this page
const pageUrl = new URL(`/company/${company.slug}/`, Astro.site).toString();

/* ---------- Contact (dynamic zone) ---------- */
const contactItems: any[] = Array.isArray(company.contact) ? company.contact : [];
const socials = contactItems.filter((c) => c?.__component === "contact.social-profile");

/* ---------- Share config (Strapi overrides + fallbacks) ---------- */
const shareSettings = company.ShareSettings || company.share_settings || {};

const shareEnabled = shareSettings.Enable ?? true;

const canonicalUrl =
  shareSettings.link_override?.trim() ||
  `https://bigbeautifulboycott.us/company/${company.slug}`;

// base text fallbacks
const baseTitle = `${company.name} – Big Beautiful Boycott`;
const baseMessage =
  shareSettings.message?.trim() ||
  company.intro ||
  company.about ||
  `Learn more about ${company.name} on Big Beautiful Boycott.`;

const baseShort =
  shareSettings.message_short?.trim() ||
  `${company.name} on Big Beautiful Boycott`;

const shareTitle = shareSettings.title?.trim() || baseTitle;
const shareMessage = baseMessage;
const shareMessageShort = baseShort;
const shareHashtags = shareSettings.hashtags?.trim() || "BigBeautifulBoycott";
---

<Base>
  <article class="company prose max-w-none">
    <CompanyHeader company={company} />

    {shareEnabled && (
      <CompanyShare
        url={canonicalUrl}
        title={shareTitle}
        message={shareMessage}
        messageShort={shareMessageShort}
        hashtags={shareHashtags}
      />
    )}

    {socials.length > 0 && (
      <div>
        <div class="company-social">
          {socials.map((s) => {
            const iconUrl = iconForPlatform(s.platform);
            const label = s.label ?? s.platform;
            const href = String(s.url || "").startsWith("http") ? s.url : `https://${s.url}`;
            return (
              <a
                href={href}
                target="_blank"
                rel="noopener noreferrer"
                class="company-social-item"
                data-gtm="company_outbound"
                data-dest="website"
                data-company-slug={company.slug}
                data-company-name={company.name}
              >
                {iconUrl && <img src={iconUrl} alt={String(s.platform)} loading="lazy" />}
                <span>{company.name} {label}</span>
              </a>
            );
          })}
        </div>
      </div>
    )}

    {introHtml && (
      <section class="mt-6">
        <div class="prose max-w-none" set:html={introHtml} />
      </section>
    )}

    {/* Evidence & Context + parent-company reasoning */}
    <CompanyReasoning
      reasoning_html={reasoningHtml}
      parent_reason_blocks={parentReasonBlocks}
    />

    {/* Action items: company first, then parent; note/yes/maybe/no order with emojis */}
    <CompanyActionItems
      companyName={company.name}
      sentiment={sentiment}
      companyActions={actions}
      parentActions={parentActions}
    />

    <CompanyContact
      companySlug={company.slug}
      companyName={company.name}
      contactItems={contactItems}
    />



    {/* Combined sources at the bottom */}
    <CompanySources sources={allSources} />
  </article>
</Base>
