---
// src/pages/[slug].astro

import Base from "../layouts/Base.astro";
import { strapi, unwrap } from "../lib/strapi";
import "../styles/pages.css";

/** Pre-render all page slugs */
export async function getStaticPaths() {
  const res = await strapi(
    "/api/pages"
    + "?publicationState=live"
    + "&fields=slug"
    + "&pagination[pageSize]=500"
  );
  const items = (unwrap<any[]>(res) ?? []);
  return items.map((p: any) => ({ params: { slug: p.slug }}));
}

/** Page load */
const { slug } = Astro.params;

const res = await strapi(
  "/api/pages"
  + `?filters[slug][$eq]=${encodeURIComponent(slug)}`
  + "&publicationState=live"
  // basic fields
  + "&fields=name,slug,content"
  // media at root
  + "&populate[headerImage][fields]=url,alternativeText,caption,width,height,formats"
  // SEO component
  + "&populate[SEO][fields]=metaTitle,metaDescription,canonicalUrl,structuredData"
  + "&populate[SEO][populate][shareImage][fields]=url,alternativeText,caption,width,height,formats"
);

const arr = (unwrap<any[]>(res) ?? []);
const page = Array.isArray(arr) ? arr[0] : null;

if (!page) {
  return new Response("Page not found", { status: 404 });
}

// Handle both flat and nested media shapes
const headerImage =
  page?.headerImage?.data?.attributes ??
  page?.headerImage ??
  null;

const { name, SEO, content } = page;
---

<Base seo={SEO}>
  {headerImage?.url && (
    <div class="mb-6">
      <img
        src={headerImage.url}
        alt={headerImage.alternativeText || name}
        class="w-full max-h-[360px] object-cover rounded-lg"
        loading="lazy"
      />
    </div>
  )}

  <h1 class="text-3xl font-bold mb-4">{name}</h1>

  {content && (
    <section class="prose max-w-none">
      <div set:html={content} />
    </section>
  )}
</Base>
