---
// src/layouts/Base.astro (only the Strapi calls changed)
import "../styles/global.css";
import Seo from "../components/Seo.astro";
import Header from "../components/Header.astro";
import FooterComp from "../components/Footer.astro";

import type { Global } from "../types/strapi";
import type { HeaderType } from "../types/header";
import type { Footer as FooterType } from "../types/footer";

import { strapi, unwrap, mediaUrl } from "../lib/strapi";

let global: Global = {
  siteName: "Big Beautiful Boycott",
  siteDescription: "BBB",
  defaultSeo: {},
};
let header: HeaderType | null = null;
let footer: FooterType = {};

try {
  const globalRes = await strapi("/api/global?populate=*");
  const g = unwrap<Global>(globalRes);
  if (g?.siteName && g?.siteDescription) global = g;
} catch (_) {}

let faviconUrl = "";
try {
  faviconUrl = mediaUrl(
    global?.favicon?.data?.attributes?.url ?? (global as any)?.favicon?.url
  );
} catch (_) {}

try {
  const headerRes = await strapi(
    "/api/header"
    + "?populate[logo][fields][0]=url"
    + "&populate[logo][fields][1]=alternativeText"
    + "&populate[nav][populate]=*"
    + "&populate[ctas][populate]=*"
  );
  header = unwrap<HeaderType>(headerRes) ?? null;
} catch (_) {}

try {
  const footerRes = await strapi(
    "/api/footer"
    + "?populate[logo][fields][0]=url"
    + "&populate[logo][fields][1]=alternativeText"
    + "&populate[sections][populate]=*"
    + "&populate[bottom_links]=*"
  );
  footer = (unwrap<FooterType>(footerRes) ?? {}) as FooterType;
} catch (_) {}

const defaultTheme = "bbb-default";
---
<html lang="en" data-theme={defaultTheme}>
  <head>
    <script src="/theme.js" is:inline></script>
    <Seo
      siteName={global.siteName}
      siteDescription={global.siteDescription}
      faviconUrl={faviconUrl}
      seo={global.defaultSeo}
    />
  </head>
  <body class="min-h-dvh bg-base-100 text-base-content">
    {header && <Header header={header} />}
    <main class="mx-auto max-w-7xl w-full px-4 py-8">
      <slot />
    </main>
    <FooterComp footer={footer} />
  </body>
</html>
